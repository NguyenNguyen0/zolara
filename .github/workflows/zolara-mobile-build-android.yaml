name: Build Android App with EAS

on:
  push:
    paths:
      - 'zolara-mobile/**'
    branches: [dev-admin, main]
  workflow_dispatch:
    inputs:
      build_profile:
        description: 'Build profile (development, preview, production)'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production
      api_url:
        description: 'Custom API URL (optional - overrides profile default)'
        required: false

defaults:
  run:
    working-directory: zolara-mobile

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Expo Token
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "âŒ EXPO_TOKEN is required but not set"
            exit 1
          fi
          echo "âœ… EXPO_TOKEN is configured"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x  # Recommended by Expo
          cache: 'npm'
          cache-dependency-path: zolara-mobile/package-lock.json

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          eas-cache: true  # Enable EAS caching
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Determine build profile and API URL
        id: build-config
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PROFILE="${{ github.event.inputs.build_profile }}"
            CUSTOM_API_URL="${{ github.event.inputs.api_url }}"
          else
            # Auto-select profile based on branch
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              PROFILE="production"
            else
              PROFILE="preview"
            fi
          fi
          
          echo "build_profile=$PROFILE" >> $GITHUB_OUTPUT
          
          # Set API URL based on profile or custom input
          if [ -n "$CUSTOM_API_URL" ]; then
            API_URL="$CUSTOM_API_URL"
          elif [ "$PROFILE" = "production" ]; then
            API_URL="${{ secrets.EXPO_PUBLIC_API_URL_PROD || 'https://api.zolara.com/api/v1' }}"
          elif [ "$PROFILE" = "preview" ]; then
            API_URL="${{ secrets.EXPO_PUBLIC_API_URL_STAGING || 'https://api-staging.zolara.com/api/v1' }}"
          else
            API_URL="${{ secrets.EXPO_PUBLIC_API_URL_DEV || 'http://10.0.2.2:3000/api/v1' }}"
          fi
          
          # Validate API URL format
          if [[ ! "$API_URL" =~ ^https?:// ]]; then
            echo "âŒ Invalid API URL format: $API_URL"
            exit 1
          fi
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "âœ… Using build profile: $PROFILE"
          echo "âœ… Using API URL: $API_URL"

      - name: Verify EAS Configuration
        run: |
          if ! eas build:list --limit=1 --non-interactive > /dev/null 2>&1; then
            echo "âŒ EAS configuration error or authentication failed"
            exit 1
          fi
          echo "âœ… EAS configuration verified"

      - name: Run EAS Build (Android)
        run: |
          echo "ðŸš€ Starting EAS build for Android..."
          eas build \
            --platform android \
            --profile ${{ steps.build-config.outputs.build_profile }} \
            --non-interactive \
            --clear-cache \
            --message "Build from ${{ github.ref_name }} by ${{ github.actor }}"
        env:
          EXPO_PUBLIC_API_URL: ${{ steps.build-config.outputs.api_url }}

      - name: Build Success Notification
        if: success()
        run: |
          echo "ðŸŽ‰ Build completed successfully!"
          echo "Check your EAS Dashboard: https://expo.dev/"

      - name: Build Failure Notification  
        if: failure()
        run: |
          echo "ðŸ’¥ Build failed!"
          echo "Check the logs above for details"
          echo "Common issues:"
          echo "- Invalid EAS configuration"
          echo "- Missing dependencies" 
          echo "- API URL connectivity issues"

      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: ${{ steps.build-config.outputs.build_profile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${{ steps.build-config.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Android" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± Check your [EAS Dashboard](https://expo.dev/) for build details and download links." >> $GITHUB_STEP_SUMMARY